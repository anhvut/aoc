import {serializePoint} from '../util';

const parse = (input: string[]) => {
  return input.map((x) => x.split(''));
};

const reflectMap1 = {
  [serializePoint([1, 0])]: [0, -1],
  [serializePoint([0, 1])]: [-1, 0],
  [serializePoint([-1, 0])]: [0, 1],
  [serializePoint([0, -1])]: [1, 0]
};

const reflectMap2 = {
  [serializePoint([1, 0])]: [0, 1],
  [serializePoint([0, 1])]: [1, 0],
  [serializePoint([-1, 0])]: [0, -1],
  [serializePoint([0, -1])]: [-1, 0]
};

function count(grid: string[][], beams: number[][]) {
  const mx = grid[0].length;
  const my = grid.length;
  const visited = grid.map((r) => r.map(() => '.'));
  const visitedDir = grid.map((r) => r.map(() => ({})));
  while (true) {
    let nextBeams = [];
    for (let [x, y, dx, dy] of beams) {
      const serializedDir = serializePoint([dx, dy]);
      if (x < 0 || x >= mx || y < 0 || y >= my || visitedDir[y][x][serializedDir]) continue;
      visited[y][x] = '#';
      visitedDir[y][x][serializedDir] = true;
      switch (grid[y][x]) {
        case '.':
          nextBeams.push([x, y, dx, dy]);
          break;
        case '-':
          if (dx) nextBeams.push([x, y, dx, dy]);
          else nextBeams.push([x, y, -1, 0], [x, y, 1, 0]);
          break;
        case '|':
          if (dy) nextBeams.push([x, y, dx, dy]);
          else nextBeams.push([x, y, 0, -1], [x, y, 0, 1]);
          break;
        case '/':
          nextBeams.push([x, y, ...reflectMap1[serializedDir]]);
          break;
        case '\\':
          nextBeams.push([x, y, ...reflectMap2[serializedDir]]);
          break;
        default:
          throw new Error(`Unknown char ${grid[y][x]}`);
      }
    }
    for (const b of nextBeams) {
      b[0] += b[2];
      b[1] += b[3];
    }
    if (!nextBeams.length) break;
    beams = nextBeams;
  }
  return Array.from(visited.flat()).filter((c) => c === '#').length;
}

const part1 = (input: string[]) => {
  const grid = parse(input);
  return count(grid, [[0, 0, 1, 0]]);
};

const part2 = (input: string[]) => {
  const grid = parse(input);
  const mx = grid[0].length;
  const my = grid.length;
  let result = 0;

  for (let x = 0; x < mx; x++)
    result = Math.max(result, count(grid, [[x, 0, 0, 1]]), count(grid, [[x, my - 1, 0, -1]]));
  for (let y = 0; y < my; y++)
    result = Math.max(result, count(grid, [[0, y, 1, 0]]), count(grid, [[mx - 1, y, -1, 0]]));
  return result;
};

const runs = [1, 1, 1, 1];

const inputSample = `
.|...\\....
|.-.\\.....
.....|-...
........|.
..........
.........\\
..../.\\\\..
.-.-/..|..
.|....-|.\\
..//.|....
`
  .trim()
  .split('\n');

const inputReal = `
\\..|.....................|.-........\\.............-................|./....|.....-...-.........................
.......\\.........|..............-...||..............-...........--.|...............||..........\\............|.
........../.....................\\.........\\..................\\....|.....-.................../..-.\\............
................/..../........../..-....|\\.|...-...................\\....|/........|...........................
.....|../-\\.|....|................................--.-./..........|.........../..-....-................-....|.
.../..........\\................-.......\\................|/..\\.................\\.....\\...|....../............./
..-../.../......-.....\\........//.............|.........../...|.........../.......-...........................
......\\....../......./..|\\............/..........................\\..............\\.....\\.........|......-...|..
.|/.......\\.........|...../..//...................................-....-...........././-...............-......
........-....../......./..\\.............|.....................\\........../-....../........-...................
......-........./\\..................../..\\|..-//....|.\\--................|.....|.../............-............\\
........................|...-........|..............|..............|................./........................
...................|................|..../...-...................../...|......\\..................|...|\\.......
....-......../.\\...............\\-...\\...........................................................|.............
.............../.|.......|.........\\.\\.........................-|.............\\........-.../...-...||.........
....-...-\\.-............/...../...../..\\........\\|....\\...............\\.............-........................\\
........././.......//......-...|...........-...|..|....-......-.......|............................|../.......
\\.................|..../.....-..|......./.....................\\....../...|./\\.\\...............-............./.
.....-\\............../...................................../....\\.....-|...........-.\\...../............\\.....
......................./..\\..................|...............-.........-..../......../..|.....................
....\\...................../...../......|...........................\\......||.\\...-..............-...........|.
..........................|........../...........|....-.......\\........................-|..\\............/..|..
-./...|..............................................|./../.........-|.\\.|..........\\........../.........\\....
...........|......................-............................|.........................\\....-........../....
........................|/....\\......../.|.......\\.........../..................\\........................-....
...../.................-............................-.\\......|...............\\...........\\.....-.............-
....|-.............-.../....\\...........-...........|\\.............-.............../-....../..................
...............\\/.............../.|............................/.|...................-............-...........
.................\\.....\\........./......../.....\\.....|........-..\\..........................|................
...............-..-........-........../...../...\\.................\\..-.-.....|..........\\..............\\......
.............-....../....|.\\\\............|......|.........-.......|................/.......|./............\\...
.................................................\\.......\\-....\\.........|.....-..|.........-................/
.............../..............\\..........................\\.................-\\............-............-.......
/....|...../.....................................................-....\\.....-................../..........-..\\
.....\\.....................-...........|...\\.....-...../.......-.|.................|..........................
.............-..........-....-....-.-../....|.......-.\\.........................-........../..../.....\\.......
..........\\\\.........................../...-........./........\\............|.........../......................
............-......|..................................................................-......./...-...........
........\\............-......|....\\............................\\.\\........|......................../......\\...-
......../...|........|..-.-.../..../..........|........|....../....../../...........\\.............\\....../....
......|.........-........//........-../....\\........./..........|.-......-...-......-.............\\..|........
./......................../................-..........................................-.....--....|...........
....../............\\\\..../\\............|..-.|.|.-.............-........|................................./.../
..-......../.......|.......|........................-....-..............................-.....................
.........||............|.\\................|......................./.\\...............-..........|..../..-..\\...
\\|.......|..\\..........-.................../|.....-.............\\............./....................../........
.....................|....-.../...............\\.\\.............................................................
............|.......................\\...........-......|...././.-...../................|........-..........\\.\\
..........|../\\.|.......|\\..-............\\.-..............-....../...\\......||..\\........-.\\..../...\\......./|
..|.....................................-\\............//.......|..\\..............\\.........|....|.............
.....\\...............................-........./..........\\.........-....|..........-./../...\\................
.....\\./....-...\\....................\\|.........\\.............-...\\..........-...............|............./..
/./\\......\\.........\\........-../......../.....|/..................../.././..-......................|\\........
.|\\...-.\\\\.......................|........-\\.....|......|......./|..........-..../...................|.|......
...........\\.............\\./....|./.............................|.............................................
.../...../.|.................\\...../.....-..............|.\\.\\../.................../.............\\............
..............\\............-........-........\\....../............|....|...\\....\\...|.....-..../...............
/.\\.\\........-....\\.|....-....\\..../...-./...............-.......\\../........./..../........./.......\\........
|..............................-..\\............................\\......//........\\../...-../..\\......../.......
.............\\.../.\\............\\--............|................-|............|......../......................
...../....|................................-.....................................|./..........|.........\\.\\\\..
........./......-.....|............/.-.......\\..-.......................................|..................\\..
.......\\.\\.....................-|...../.....|........|............-..............-....../\\..\\....../..........
|..\\.|........../|..\\..|\\..-...................\\.................../.....-/...............|................../
...........|..-..............|........................-..............-...............-.............\\.........\\
...\\./.....-...|.-.......-................/.\\.....-..-...|......-.......................................--...|
...............-.........|............-............|./.......\\...../.....\\............-.\\.....................
..................|......|..........-..............................-....|............|.\\........./..-.........
|......................../.....-../|.....\\./..\\....|......................./........................./...\\....
....|............-........\\..-...............-................/\\..........................|........|.......\\-.
|......./.....\\.......\\..................-.\\..../....|............|.../..................../|.../........../..
...-|..................||......--......\\......|.............|\\........./.................\\......\\........\\....
./........./........-...................................\\......-......................................-.....-.
.....\\..-\\-....\\........................|........../.......|.........-.............................///........
./.............\\........./.................|.....................|..\\.........../...|...|..\\.|............-...
.................................\\.................................\\...........................-.........-....
...................\\....|...............|...............\\..../.....-.....................................\\....
.../.......-.......|...........|.....\\..................../......................|../.............\\...........
......-....................../..../.....-..............\\............./...........-.....\\....|...............|.
......-.......-.......|..................\\................-...|./.......--............../.......|.-.|.........
-..................\\........../..........................-...-.............../..............................|.
............/.........-..../\\..-.....\\....\\........./.........\\.........../.........|/.../....................
...................................../.....|..\\.............\\..........-.......\\............../.............|.
..../........./.........................-.......\\..|..|.....--|...../.............../..-/./.......|..../|.....
.........\\.|...|..|-...................................\\../..-.....|....\\....................-................
..../..-......|..............\\../............./..........-.|......../..........|.\\........|..................-
......|.................\\..........\\|...................-.../.\\.........../.|............../................./
.........................\\.................................../-./............................-..-.........|...
\\...........-................/....-.-....................................../...../..............\\.......-\\.../
-....................................\\.........................../.............................|..............
......................\\............\\.......\\..\\.............\\.................-....\\....-.|...................
.|-.-...../......./............./........|.................../.........-..\\........./.\\|...........-..........
.......\\..............\\.....-..........\\.|.\\...|.........\\/..........\\......|.\\...................-...........
../.-..................../..................|.....-...-....-............................-.-..-../..\\..........
.................................-.......|...../.\\.................\\..../................................-....
.-..|.....|.........-........|....-.........../...........\\......-..........................\\.................
..-.................../...|..-..|...................../...-...|........................................./|....
.........................-\\............................./....................../.......-................|.....
........../.......\\.........|...-/........./............./......................../...........-../..\\.-\\...-..
..........|....\\-........\\...................-.|....-.........\\................../.......\\....................
/...-..........\\......\\.........|.............|...........-....../.|..|..-............................|.......
.........\\.|........\\......\\....|.........................................../........-........................
....\\.....|.......\\....................................-............|.....-........./..\\...\\.....-..-.........
.|../...../.......|\\......\\............../....\\..|..-...-..............|-.................................-...
.|.\\......./........../........|..\\.../|......\\....|.........-.|.................-.........|............./..-.
...............-.................|...-../\\..../.......-.....|..\\./............................................
....-.|.........-........................../...................|...............\\........................../...
..|/...-..../../...-........-...-.....................................\\.......................................
............../....|.....-\\.....-................................../\\.....................\\....-........-.....
......../.|.................|......|.|.-....|...................../....................................\\......

`
  .trim()
  .split('\n');

if (runs[0]) console.log('part1 sample', part1(inputSample));
if (runs[1]) console.log('part1 real', part1(inputReal));
if (runs[2]) console.log('part2 sample', part2(inputSample));
if (runs[3]) {
  console.time('part2 real');
  console.log('part2 real', part2(inputReal));
  console.timeEnd('part2 real');
}
