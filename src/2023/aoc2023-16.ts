import {DOWN, LEFT, POINT, pointAdd, RIGHT, SERIALIZED_POINT, serializePoint, UP} from '../util';

const parse = (input: string[]) => {
  return input.map((x) => x.split(''));
};

const reflectMap1: Record<SERIALIZED_POINT, POINT> = {
  [serializePoint(RIGHT)]: UP,
  [serializePoint(DOWN)]: LEFT,
  [serializePoint(LEFT)]: DOWN,
  [serializePoint(UP)]: RIGHT
};

const reflectMap2: Record<SERIALIZED_POINT, POINT> = {
  [serializePoint(RIGHT)]: DOWN,
  [serializePoint(DOWN)]: RIGHT,
  [serializePoint(LEFT)]: UP,
  [serializePoint(UP)]: LEFT
};

type BEAM = {point: POINT; dir: POINT};

function count(grid: string[][], beams: Array<BEAM>) {
  const mx = grid[0].length;
  const my = grid.length;
  const energized: Record<SERIALIZED_POINT, boolean> = {};
  const visited: Record<`${SERIALIZED_POINT};${SERIALIZED_POINT}`, boolean> = {};
  while (true) {
    let nextBeams: Array<BEAM> = [];
    for (let {point, dir} of beams) {
      const [x, y] = point;
      const serializedPoint = serializePoint(point);
      const serializedDir = serializePoint(dir);
      const key = `${serializedPoint};${serializedDir}`;
      if (x < 0 || x >= mx || y < 0 || y >= my || visited[key]) continue;
      visited[key] = true;
      energized[serializedPoint] = true;
      switch (grid[y][x]) {
        case '.':
          nextBeams.push({point, dir});
          break;
        case '-':
          if (dir[0]) nextBeams.push({point, dir});
          else nextBeams.push({point, dir: LEFT}, {point, dir: RIGHT});
          break;
        case '|':
          if (dir[1]) nextBeams.push({point, dir});
          else nextBeams.push({point, dir: UP}, {point, dir: DOWN});
          break;
        case '/':
          nextBeams.push({point, dir: reflectMap1[serializedDir]});
          break;
        case '\\':
          nextBeams.push({point, dir: reflectMap2[serializedDir]});
          break;
        default:
          throw new Error(`Unknown char ${grid[y][x]}`);
      }
    }
    if (!nextBeams.length) break;
    beams = nextBeams.map(({point, dir}) => ({point: pointAdd(point, dir), dir}));
  }
  return Object.keys(energized).length;
}

const part1 = (input: string[]) => {
  const grid = parse(input);
  return count(grid, [{point: [0, 0], dir: RIGHT}]);
};

const part2 = (input: string[]) => {
  const grid = parse(input);
  const mx = grid[0].length;
  const my = grid.length;
  let result = 0;

  for (let x = 0; x < mx; x++) {
    const downward = count(grid, [{point: [x, 0], dir: DOWN}]);
    const upward = count(grid, [{point: [x, my - 1], dir: UP}]);
    result = Math.max(result, downward, upward);
  }
  for (let y = 0; y < my; y++) {
    const rightward = count(grid, [{point: [0, y], dir: RIGHT}]);
    const leftward = count(grid, [{point: [mx - 1, y], dir: LEFT}]);
    result = Math.max(result, rightward, leftward);
  }
  return result;
};

const runs = [1, 1, 1, 1];

const inputSample = `
.|...\\....
|.-.\\.....
.....|-...
........|.
..........
.........\\
..../.\\\\..
.-.-/..|..
.|....-|.\\
..//.|....
`
  .trim()
  .split('\n');

const inputReal = `
\\..|.....................|.-........\\.............-................|./....|.....-...-.........................
.......\\.........|..............-...||..............-...........--.|...............||..........\\............|.
........../.....................\\.........\\..................\\....|.....-.................../..-.\\............
................/..../........../..-....|\\.|...-...................\\....|/........|...........................
.....|../-\\.|....|................................--.-./..........|.........../..-....-................-....|.
.../..........\\................-.......\\................|/..\\.................\\.....\\...|....../............./
..-../.../......-.....\\........//.............|.........../...|.........../.......-...........................
......\\....../......./..|\\............/..........................\\..............\\.....\\.........|......-...|..
.|/.......\\.........|...../..//...................................-....-...........././-...............-......
........-....../......./..\\.............|.....................\\........../-....../........-...................
......-........./\\..................../..\\|..-//....|.\\--................|.....|.../............-............\\
........................|...-........|..............|..............|................./........................
...................|................|..../...-...................../...|......\\..................|...|\\.......
....-......../.\\...............\\-...\\...........................................................|.............
.............../.|.......|.........\\.\\.........................-|.............\\........-.../...-...||.........
....-...-\\.-............/...../...../..\\........\\|....\\...............\\.............-........................\\
........././.......//......-...|...........-...|..|....-......-.......|............................|../.......
\\.................|..../.....-..|......./.....................\\....../...|./\\.\\...............-............./.
.....-\\............../...................................../....\\.....-|...........-.\\...../............\\.....
......................./..\\..................|...............-.........-..../......../..|.....................
....\\...................../...../......|...........................\\......||.\\...-..............-...........|.
..........................|........../...........|....-.......\\........................-|..\\............/..|..
-./...|..............................................|./../.........-|.\\.|..........\\........../.........\\....
...........|......................-............................|.........................\\....-........../....
........................|/....\\......../.|.......\\.........../..................\\........................-....
...../.................-............................-.\\......|...............\\...........\\.....-.............-
....|-.............-.../....\\...........-...........|\\.............-.............../-....../..................
...............\\/.............../.|............................/.|...................-............-...........
.................\\.....\\........./......../.....\\.....|........-..\\..........................|................
...............-..-........-........../...../...\\.................\\..-.-.....|..........\\..............\\......
.............-....../....|.\\\\............|......|.........-.......|................/.......|./............\\...
.................................................\\.......\\-....\\.........|.....-..|.........-................/
.............../..............\\..........................\\.................-\\............-............-.......
/....|...../.....................................................-....\\.....-................../..........-..\\
.....\\.....................-...........|...\\.....-...../.......-.|.................|..........................
.............-..........-....-....-.-../....|.......-.\\.........................-........../..../.....\\.......
..........\\\\.........................../...-........./........\\............|.........../......................
............-......|..................................................................-......./...-...........
........\\............-......|....\\............................\\.\\........|......................../......\\...-
......../...|........|..-.-.../..../..........|........|....../....../../...........\\.............\\....../....
......|.........-........//........-../....\\........./..........|.-......-...-......-.............\\..|........
./......................../................-..........................................-.....--....|...........
....../............\\\\..../\\............|..-.|.|.-.............-........|................................./.../
..-......../.......|.......|........................-....-..............................-.....................
.........||............|.\\................|......................./.\\...............-..........|..../..-..\\...
\\|.......|..\\..........-.................../|.....-.............\\............./....................../........
.....................|....-.../...............\\.\\.............................................................
............|.......................\\...........-......|...././.-...../................|........-..........\\.\\
..........|../\\.|.......|\\..-............\\.-..............-....../...\\......||..\\........-.\\..../...\\......./|
..|.....................................-\\............//.......|..\\..............\\.........|....|.............
.....\\...............................-........./..........\\.........-....|..........-./../...\\................
.....\\./....-...\\....................\\|.........\\.............-...\\..........-...............|............./..
/./\\......\\.........\\........-../......../.....|/..................../.././..-......................|\\........
.|\\...-.\\\\.......................|........-\\.....|......|......./|..........-..../...................|.|......
...........\\.............\\./....|./.............................|.............................................
.../...../.|.................\\...../.....-..............|.\\.\\../.................../.............\\............
..............\\............-........-........\\....../............|....|...\\....\\...|.....-..../...............
/.\\.\\........-....\\.|....-....\\..../...-./...............-.......\\../........./..../........./.......\\........
|..............................-..\\............................\\......//........\\../...-../..\\......../.......
.............\\.../.\\............\\--............|................-|............|......../......................
...../....|................................-.....................................|./..........|.........\\.\\\\..
........./......-.....|............/.-.......\\..-.......................................|..................\\..
.......\\.\\.....................-|...../.....|........|............-..............-....../\\..\\....../..........
|..\\.|........../|..\\..|\\..-...................\\.................../.....-/...............|................../
...........|..-..............|........................-..............-...............-.............\\.........\\
...\\./.....-...|.-.......-................/.\\.....-..-...|......-.......................................--...|
...............-.........|............-............|./.......\\...../.....\\............-.\\.....................
..................|......|..........-..............................-....|............|.\\........./..-.........
|......................../.....-../|.....\\./..\\....|......................./........................./...\\....
....|............-........\\..-...............-................/\\..........................|........|.......\\-.
|......./.....\\.......\\..................-.\\..../....|............|.../..................../|.../........../..
...-|..................||......--......\\......|.............|\\........./.................\\......\\........\\....
./........./........-...................................\\......-......................................-.....-.
.....\\..-\\-....\\........................|........../.......|.........-.............................///........
./.............\\........./.................|.....................|..\\.........../...|...|..\\.|............-...
.................................\\.................................\\...........................-.........-....
...................\\....|...............|...............\\..../.....-.....................................\\....
.../.......-.......|...........|.....\\..................../......................|../.............\\...........
......-....................../..../.....-..............\\............./...........-.....\\....|...............|.
......-.......-.......|..................\\................-...|./.......--............../.......|.-.|.........
-..................\\........../..........................-...-.............../..............................|.
............/.........-..../\\..-.....\\....\\........./.........\\.........../.........|/.../....................
...................................../.....|..\\.............\\..........-.......\\............../.............|.
..../........./.........................-.......\\..|..|.....--|...../.............../..-/./.......|..../|.....
.........\\.|...|..|-...................................\\../..-.....|....\\....................-................
..../..-......|..............\\../............./..........-.|......../..........|.\\........|..................-
......|.................\\..........\\|...................-.../.\\.........../.|............../................./
.........................\\.................................../-./............................-..-.........|...
\\...........-................/....-.-....................................../...../..............\\.......-\\.../
-....................................\\.........................../.............................|..............
......................\\............\\.......\\..\\.............\\.................-....\\....-.|...................
.|-.-...../......./............./........|.................../.........-..\\........./.\\|...........-..........
.......\\..............\\.....-..........\\.|.\\...|.........\\/..........\\......|.\\...................-...........
../.-..................../..................|.....-...-....-............................-.-..-../..\\..........
.................................-.......|...../.\\.................\\..../................................-....
.-..|.....|.........-........|....-.........../...........\\......-..........................\\.................
..-.................../...|..-..|...................../...-...|........................................./|....
.........................-\\............................./....................../.......-................|.....
........../.......\\.........|...-/........./............./......................../...........-../..\\.-\\...-..
..........|....\\-........\\...................-.|....-.........\\................../.......\\....................
/...-..........\\......\\.........|.............|...........-....../.|..|..-............................|.......
.........\\.|........\\......\\....|.........................................../........-........................
....\\.....|.......\\....................................-............|.....-........./..\\...\\.....-..-.........
.|../...../.......|\\......\\............../....\\..|..-...-..............|-.................................-...
.|.\\......./........../........|..\\.../|......\\....|.........-.|.................-.........|............./..-.
...............-.................|...-../\\..../.......-.....|..\\./............................................
....-.|.........-........................../...................|...............\\........................../...
..|/...-..../../...-........-...-.....................................\\.......................................
............../....|.....-\\.....-................................../\\.....................\\....-........-.....
......../.|.................|......|.|.-....|...................../....................................\\......

`
  .trim()
  .split('\n');

if (runs[0]) console.log('part1 sample', part1(inputSample));
if (runs[1]) console.log('part1 real', part1(inputReal));
if (runs[2]) console.log('part2 sample', part2(inputSample));
if (runs[3]) {
  console.time('part2 real');
  console.log('part2 real', part2(inputReal));
  console.timeEnd('part2 real');
}
