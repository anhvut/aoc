const parse = (input: string[]) => input.map((x) => x.split(''));

const toolkit = (lines: string[][]) => {
  const maxX = lines[0].length;
  const maxY = lines.length;

  const count = (input: string[] | string[][] =lines) => {
    let result = 0;
    for (let x = 0; x < maxX; x++)
      for (let y = 0; y < maxY; y++)
        if (input[y][x] === 'O')
          result += maxY - y;
    return result;
  };

  const shakeNorth = () => {
    for (let x = 0; x < maxX; x++) {
      let nextY = 0;
      for (let y = 0; y < maxY; y++) {
        if (lines[y][x] === 'O') {
          lines[y][x] = '.';
          lines[nextY][x] = 'O';
          nextY++;
        } else if (lines[y][x] === '#') nextY = y + 1;
      }
    }
  };

  const shakeSouth = () => {
    for (let x = 0; x < maxX; x++) {
      let nextY = maxY - 1;
      for (let y = maxY - 1; y >= 0; y--) {
        if (lines[y][x] === 'O') {
          lines[y][x] = '.';
          lines[nextY][x] = 'O';
          nextY--;
        } else if (lines[y][x] === '#') nextY = y - 1;
      }
    }
  };

  const shakeWest = () => {
    for (let y = 0; y < maxY; y++) {
      let nextX = 0;
      for (let x = 0; x < maxX; x++) {
        if (lines[y][x] === 'O') {
          lines[y][x] = '.';
          lines[y][nextX] = 'O';
          nextX++;
        } else if (lines[y][x] === '#') nextX = x + 1;
      }
    }
  };

  const shakeEast = () => {
    for (let y = 0; y < maxY; y++) {
      let nextX = maxX - 1;
      for (let x = maxX - 1; x >= 0; x--) {
        if (lines[y][x] === 'O') {
          lines[y][x] = '.';
          lines[y][nextX] = 'O';
          nextX--;
        } else if (lines[y][x] === '#') nextX = x - 1;
      }
    }
  };

  const makeSnapshot = () => lines.map((l) => l.join(''));

  return {count, shakeNorth, shakeWest, shakeSouth, shakeEast, makeSnapshot};
};

const part1 = (input: string[]) => {
  const {count, shakeNorth} = toolkit(parse(input));
  shakeNorth();
  return count();
};

const part2 = (input: string[], total = 1000000000) => {
  const lines = parse(input);
  const {count, shakeNorth, shakeWest, shakeSouth, shakeEast, makeSnapshot} = toolkit(lines);

  const snapshots = [makeSnapshot()];
  const equals = (snap: string[], next: string[]) => snap.every((l, y) => l === next[y]);

  for (let runs = 1; runs <= total; runs++) {
    shakeNorth();
    shakeWest();
    shakeSouth();
    shakeEast();
    const next = makeSnapshot();
    const firstRepeat = snapshots.findIndex((snap) => equals(snap, next));
    if (firstRepeat >= 0) {
      const modulo = runs - firstRepeat;
      const equivalent = firstRepeat + ((total - firstRepeat) % modulo);
      return count(snapshots[equivalent]);
    }
    snapshots.push(next);
  }
  return count();
};

const runs = [1, 1, 1, 1];

const inputSample = `
O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....
`
  .trim()
  .split('\n');

// noinspection SpellCheckingInspection
const inputReal = `
O.O#....O.O...O..OO#OO##..O..##...#..........OO..#.OO...................O..O##.#OOO...O#.#.#.O.O#OO.
.O..OO..O.O..O......OO.#....#O#.#.#.#.#.O.OO...#.O#.OOO.#.#.#.OO..#.#O...O.O.O.O#.#.O.O....#..O#O...
O....#..O..O.OO..#OO.O.....O#OOO..#.#......O...#..#..O......#O.#.O.#.O...#.#.#.........O#.......#OO.
......O.O##......###OO#..O#.#...O...O.....##.........#.OO.#........#OO.O....###...#.##..O........O.#
#.OO.....OOO....O.....OO.OOO..#O.OO...#...O......OO###........O..#.#.O..O......O#...O.....#.#...##..
#..O.#..OO.OO.O.OOO#O...O......O..#O..O#.O.O.O#....O.#O.O.....#..#..O.O.#O..O....O#.O..#....O#......
#..O#...O.O.O..O...#.O.#.O..........O.#.#.........O.......##...#..O.OO#......#.......O.#.#..#.OO##O.
O.O..O..#......#....#O....O..O#.OOO..#..O#.OO#.........O..##...O..#.........O##...O....O..O.O.O..O..
O.O#.O...OO....O....##O.O......O.O..O....#...O...O##........#.......#....O..O.......O...#O.....#....
..O.#..#..OO.O..#...#..O#OOO..#.O.#O#OOO....#..OOO.#O..O..#.OOOO.........O#..O..O...O.##..O......#..
##..#..#.....O..OO###.........##..##..OO...#..#O.#......#O...O.....#........#....OO.#OO.#.O....#.O#O
.O.....O.O.O....#OO..O.##OO#..O.....O..#..O..#....O..O#....O..#.OO..O....OO..O.O..O#.....O.O.#O..OO.
O#O.##O#..................O.OO...#...#..#O....O..O..OO#.O#...##.O...##.OO#.....O.#.#...##..O.OO..O..
O.....OO..OO..#OO#.....O.O.#....OO.#...###.......O#...##....##.O..##......#......O#O..OO.OO....O....
.......O.O.#..O..O.#.O..O.O#O.#....##.OO.#...#.OO#..O...#..O...O...#.#...O#.....O#O........O...##.#O
#....O..O..OOO...#....#.##.#....O.............##O#...#..O.O.##..#.O..O.#...#.O.##O..##.#...O......##
.O...##.O.....#OO.O..O..#O.#.#...O....#...#...O..#O...........##..OO##...#...#..O#O.........O..#..#O
O...O...O..#..#OO.....OOO.#.........O..O.......#.#.#...OO##..O...O.....O#.#..O........#.#.O.O..##.#.
.###...#.....#..#O.O.......O.....O#.OO....##.OO.........O#...OO.OO#.#....#O#OO.O..#.OOOOO.....O...O.
O#.#..#..OO...O..OO.#...#..........#OO#.#..O.#...##O...#..O.O....#.O....#..##.#.#.#O.#...#..#...O#..
.#..#OO.....O..O....O........O#.O.OO....##....OO....O##O..##.#O..O#O##.O.O.O#..OO.....O#.#.........#
O.O.#..#O...O..O..O....O.....#OOO.O.......O#.OO..O.....#O...O#...O...O......#.#.#....#..#OO.#OOO...#
.O.....O..#O.##OO..#OOOO..#O.O.#O....OO#OOO....O....OO...O........#..O...O...O....#.O#O.O.#O.#.O.O..
........O.O.......O...OO...###..OO.O.....OO.O..#...#OO..#....O#......##.........#.#...#.O.O....#....
.O.....##..O..#OO#OO.##...#O..#.OO..#..O.#O......#O..............O.....O.O.#O.O..#O.O...O.OO.O#..#O.
O..#.#......O#..OO..#......O.O.OOO.O...O.#....#....O#...O....##..#.....O..#....O#OOO....O.O..O......
.....O.O.....O.#..O...#O#.O..O#O..#O..##...O.#..O........O.#.O.O......OO.#....O.#.#.O..O....O#....#.
..#......#OO.O.#.#..OO...#.#..O.#....O#.#O.OOO....O###......#....O.##..O..#.O.#.#.O......O#.OO....#O
#..O...OOO..O....OO.O..#..O.OO.#OO.OOO#....OO#......OO.O....O.OO..##.O.#..O...#.#.......O.....#..O..
#..#O..O.O...#......O##.O.#......#..O##....#O####OO.#.##.O#.O.#.#...#.OO....O...#O....OO#O#.###.....
..##.#..O..####.#.#..O..O.#O.O#.###O...#.##O.#.#.O.O..#..O#.O.OO.#.O#.O.OO.#.O..#......#...#..O##O..
.#.#..O...#..O.O.O.O#O..###O.O..#O..##..#.#...#OO.........O#.....##....#O..#...O...#...#...OO...O..O
..OOO..O..#OOO.O.#..#......#....OO.........O.#.O...O#......O.O...##.#..#.OO#O.....O......#........#.
O.#O....O..O..O.......O..........#..OO#OO.O...#.O#.O....O..........O.....#.##..#..##.O#O....O.O...#.
.#.OO##......O#.O..#...O..O...##..##O..#O....#..#...O...O...#.##...#.OO##O..........#O....O....#.O.O
..O#....OOO...O#...#.....OO##..#.O.O.O..O...OOO....#.#...........OO.O#.O.#O..#..O#O#O....#..#.O.....
....#.#O.#OO..#.....#.OO.#.O..O.O.###O.O..#.#O...O..#...#..O......O...#....#..OO..........##........
......O.O..O.O..O.#.......OO.OO..##.O...........O#OO.O#.#OO.OO.......#.OO#..###O.O.........#.#O#.O.#
.OOO..#.O#O....O..#.......O...#..#.....OO...O............#O...OO........#O##.#.O.#.#.O....O#.O.OOOO.
..O..O.###OO..O.........OO.OO...#O..#...#OO.#..OO....O..O.O...O.O.....OO........#.##..#.......OO....
..OO..#O...O.O..O...O.O.O....#.O##....#..O.O..OO..#.O#..O........O.#..#......OO#O.O.O..#......##....
...O.....OO..O.OOO........O.#..OO...#........#.#...O.##O.O.O.#.#O.O...O.OOO..OO......O...#.#..O#O#..
O#...OO...O...O....O..#....#O..#...........O..........O.O..##....O..#OO.O.#........#.OO..##....OO..O
...#....#.....OOOO..#O..#...O...OO.#...OO#...##..#.#....O...O#.OO...##..O.O#...O.....#..O.OO...O..O.
#..#.O.##.O..O.O...OOO.......###..#...O.OO....#O#.....#O#O.OO..O.....#.##.#..O.#...O.OOO...O#O..O...
.OO#.......O.....##.##..#...##O..OO#O.OO.O..O...O...OO#O...#..#...O...#..#...#O..#......OO.O.....O..
O....#..OO.#...#......O.......O..OO#..O##....OO.#.#.#......#O..OO.O..O...#..#.O..O.OO##.O....O#..O..
#...#.#..#....OO...O.#..OO..O..#..#..#.O.O....#.O.O.OO.O.#.O..#.....#.#..O...#.#...#O...OO.O#.O....O
...O.#.O.....#O.OO..O..##....#O...OO........#..O..#O...O...#...#..O..O....OO..#.O.O..OO...OO...OOO#.
........#...#.##O.#..#..#......O...........O..O#.O..OO..#..O.O..#OO#......O...#.....#.##O..#....O...
.......OO#...O.O..OOO.O#O..#..#...O.O..#..#O.O.O.#..........#..#.OO...#OOOO..OO#O.O....#.O...O....O.
..OO.O..O#.O.##...O..#O....O...O.#....#O#.O..OOO.O.O.O...O.O.#.O....#.....#.O...........O...O....#..
#....OOO....O...OO#..#..O......O#...O..O#.##.#O...O.O#..........O.#.##...........#O....OO.O#O...#.##
.#......OO.O.OO#.#.#O.#O.......O..O..#......OO..#.O.O......O..O.O.O.......#O..OO....O..#.......OO.#.
...####OO...O..O..#.....#..O....O........##.O....#...#.O.OO##..#......OO.O.#....##...#..O...O.O..O#.
.....O....O.#..O.OO##...OOO#....#O#.....O#...O.O.#.O...OOO#.O.......O......OO.#..............O.#O#..
...........O..#...#OOOO....OO.##....O.O.....O..O....O...O#.....#.O.O..O....O#..#..........#O.O....O.
.#O.O...#..#......O...........#.O.....##O...OO.O.OOO..OO...O.OO#.....OO#.OO.....#O#..#O#.O.O.#..#O..
#...O..#..#.O.....O.O.#.#..#...O#..#..#O..#.....OO#.#.OO#.....O#...O.OO.............O#OOO..O.O..O.O.
.......O#O.O.#....#...........O.............O..#..OO#......OO.O...O..........OO.#..OO#O#.O##O#..O.O.
#.#......O.....OOOOO.O#O#...#.O....#...#..O#.#O....O.O#OO....#..O.O.#.#...##.OO.#.OO#.###O.....#..O.
OO...O.#............#.#.#...#..OO......#..O.#......##..OO....OO.#.OO...O..........O.#..O.#O###.O...O
##O###.OO.#.......O.O####....O.O..O.O#..#O.O.##O#......#O.##...O..#.#O..###..#.....#...#...O#....OO.
.#....O.##...O......O###........O....#.O#....#.O.#..........#.O.O.OOOO.......###...O....O......O....
...O..#...#..O.#O......#O#..O.....O....O..#...##.OOOO.OOOO#..O.#..#.......#.#O#..#..#.OO#..#.#....O#
..OO.......O#.OOOO....O..#...O.#O#....##.........#O#OO#O#..#.##.......O.O......#.....#..O.O.#O.....#
#.O........O..O.#..#.O#O...#O#........O#.O#O..O.............#OO#..O#OOO..#O###..OOO...#.O........##.
....OO.......#.O..O.O........O#.#..O.O..OO.....O....O...O#.#....O.#O#.........#....OO#O#.#OO...#.#O.
.O.O..O.......#.OO..#...O.O#.O.#.O......#.O...OOO......O.O.O.#.OO#O.O.O...O#..#.O#.#..##.O.O...O....
O..#O#O.O#.#...#..O............#O.OO...O..O...OOO##.O..O#...#.O..O#..O.O...##O.OO##O..#..OO#.OO..#OO
...#.O.......O.#.O..O.O.......O...##O...OO.#....O..O.........O.O...#.O..OO...O.O.O....O...#..#.#.OO.
OO.#...OO.#.O.....O....O..##O#O..O.OO#O....O..O.O..#.O.OO..O.O#.#.......O..O.....O.##....O.O..#.O...
#..O.#OO......##..#O.#...#...........O.##...#O...O.#..#..O..O..#...........O...OO.O...O#.........OO#
...O..OO....##.##O..O.##......#O.O#.OO..O#..OOO.OO.##OOO.#O..O.....O....O......#O...O.#.O........OO.
O.O.......OO#..O..#..O.###O...O.#...#O#O..#.#O#O.O..#O#...#.OO...O.....#.#.#O#..O.O#....O.O#..#O..O#
.#...O.###....#.......O....#...OO.....O.#.#.#.....O.#.......O..#.##.O..O#O..OO..OO..#O#......#O.#.#.
O.#.O..#O.......#.....#O#.....O.O#.......O#O.O#..##..OO.O.#..O.O..O....O...#O.O...#...##..O........O
...O........#.....O.###..O.O.O..#......O.#.....#O.O.#...O#..O#......#.O...#OO#....#O.O#......O..O#.#
O...O...OO.##.#.OO#.#OOO.#.O.O.##.O#....#..O.O#O.#..#.....OO..#O...O.O.........O...#.O...O.#...O..OO
..#...OO.#..##.O.O..O.O...O##....#.O..O.OO#...OO.O.....O...#.O.##OO.O.O.OO....#.O.O###..O#..#...O..#
..#..O.O.....O..O.....O.....OO...##.#...#..##.#..O#O.....##...O.#O...O.O.#O..#....#...OO..#..O...#O#
......#.O....O.........O..O...#.##....OO.O...#........#...#..O.O#....#.##.#.O##.O.#.......OO.....O#.
.O....O.....O.O..O..#...O......##..#.OO.#.........#...O.#.#.....O..O..O..O..OO...O..O#.##O...#.O....
....O.#.#.#.#.........O.#...#......#...#.#O#.O.O#....#...O#....O.O#O.......O#.......#O...O..O..#.O#O
...O......OO.......#O.O.#...OO.......O.........##O.......O.......#..##....##.#.#O.#O....##....#....O
....O...#OO..O..O...#.....O.#O..OO#......O#OO..#....O....OOO.O.O....#..O.#...O#........O...O.#.#O...
.O....O....OO...O......##...#O.....#...O......O....O.##OO.......#....O....O....O.O...##O...#.OO.....
#OO.O..#..O.O##...#..#.O.O..O#O.#.......O.#O..O..O.....O.......O#...O...O.........##..OO#..O.O#.##..
O.#O####...#O.O#.#OO..#O..O....OO.#O#....O........O..#.#OO.....O...O...O.......#.O#..O..#.#O.O..#.O.
O.#.....#.#.....#........O#...##O....#....O..O.O.....O#O.OO..........O..##O.O...O...#.....#....O.O..
....#OO#.#O...O###.O.#..#...O....O.........O.#...OO#.....#....O..##...O..##O......OO.O#..........OO.
O....O...O#O...#.#O...#.OO...O.....#O#.O..OOO#.OO.....#...#O#....O#..O##..O.O.#O#O###.OO....O...O#..
#...O..O##..#O.O#OO....#O...#.O#...##...O#......O.#...#....O#....O.....OOO#....O..#O#.O#O....O.#O...
#.O....##O.#.OOO..O#.O..##O#O.#O#..#.....O....##...#..O........#.O....O..#.....##.#.......#OO...#O..
...O.....#.....#.#....O.........O.....#O....O..OO.....#O.#....#...#.#O.O...#OO#.............O.O#..O#
..#O..#..#.......#....#.#.......#O..#O#....O.#O.#......#.#...#O........O.....O.#..##..O#.##...#OO...
.O.#...#.O.O......OOOOO..O.#O...O#O.#####...#..O#....O....#...O.##..#O......O..###O.#........#.O....
....##.#..O........O#O.#O#..#.....O#O.O#.....#.....#........OO.....#....O..#.O....O.#O.O.O...#.##..#
..#..O.#O#..O...O.O.............O.....#..OOO...#O#..O...#..##...O...O........#....#..O.O...##.OO..##
..OO#.O..O.....O...O.##...OO.O...O....#..O.#O.......#.#O#.OO.......#.#...O..#......O..##..##.O..O#O.
`
  .trim()
  .split('\n');

console.time('time');
if (runs[0]) console.log('part1 sample', part1(inputSample));
if (runs[1]) console.log('part1 real', part1(inputReal));
if (runs[2]) console.log('part2 sample', part2(inputSample));
if (runs[3]) console.log('part2 real', part2(inputReal));
console.timeEnd('time');
