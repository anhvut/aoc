import {arrayIndices, timeit} from '../util';

type RECORD = string[];

const parse = (input: string[]): Array<[RECORD, number[]]> =>
  input.map((l) => {
    const [r, n] = l.split(' ');
    const rec = r.split('');
    const nb = n.split(',').map((x) => +x);
    return [rec, nb] as [RECORD, number[]];
  });

const cache = {};

const serialize = (rec: RECORD, nb: number[]) => `${rec.join('')} ${nb.join(',')}`;

// remove leading and ending dots
// remove solved on the left
// if return [[], []] then it is valid
// if return null then it is invalid
const simplify = (rec: RECORD, nb: number[]) => {
  let a = 0;
  while (rec[a] === '.') a++;
  rec = rec.slice(a);
  a = rec.length - 1;
  while (a > 0 && rec[a] === '.') a--;
  rec = rec.slice(0, a + 1);
  a = 0;
  while (rec[a] === '#') a++;
  if (a === 0 && nb.length === 0) return [[], []];
  if (a === rec.length || rec[a] === '.') {
    if (a === nb[0]) {
      if (nb.length === 1) {
        if (rec.indexOf('#', a + 1) >= 0) return null;
        return [[], []];
      }
      return simplify(rec.slice(a), nb.slice(1));
    }
    return null;
  }
  return [rec, nb];
};

const count2PowN = (rec: RECORD, nb: number[]) => {
  const indices = arrayIndices(rec, '?');
  let result = 0;
  for (let i = 0, max = Math.pow(2, indices.length); i < max; i++) {
    const rec1 = rec.slice();
    for (let j = 0, p = i; j < indices.length; j++, p >>= 1) rec1[indices[j]] = (p & 1) === 0 ? '.' : '#';
    if (simplify(rec1, nb)?.[0].length === 0) result++;
  }
  return result;
};

const countCached = (rec: RECORD, nb: number[]) => {
  const s = serialize(rec, nb);
  let cached = cache[s];
  if (cached !== undefined) return cached;
  let t = simplify(rec, nb);
  if (!t) return (cache[s] = 0);
  [rec, nb] = t;
  const s2 = serialize(rec, nb);
  cached = cache[s2];
  if (cached !== undefined) return cached;
  if (rec.length === 0) return (cache[s] = cache[s2] = 1);

  const q = rec.indexOf('?');
  // assert(q >= 0)
  // assert(nb.length > 0)
  // assert(rec.length > 0)
  const rec2 = rec.slice();
  rec2[q] = '.';
  const r1 = countCached(rec2, nb);
  rec2[q] = '#';
  const r2 = countCached(rec2, nb);
  return (cache[s] = cache[s2] = r1 + r2);
};

const part1 = (input: string[]) => {
  const lines = parse(input);
  return lines.map(([rec, nb]) => count2PowN(rec, nb)).reduce((a, b) => a + b);
};

const part1Fast = (input: string[]) => {
  const lines = parse(input);
  return lines.map(([rec, nb]) => countCached(rec, nb)).reduce((a, b) => a + b);
};

const part2 = (input: string[]) => {
  const lines = parse(input);
  return lines
    .map(([rec, nb]) => {
      const nbDup = nb.slice();
      const recDup = rec.slice();
      for (let i = 1; i < 5; i++) {
        recDup.push('?', ...rec);
        nbDup.push(...nb);
      }
      return countCached(recDup, nbDup);
    })
    .reduce((a, b) => a + b);
};

const runs = [1, 1, 1, 1, 1, 1];

const inputSample = `
???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1
`
  .trim()
  .split('\n');

const inputReal = `
##.??.??##? 2,2,4
???????##?????#?#? 9,6
???#?????? 1,1,1
#???..??##..?# 1,2,3,2
??.#??#??? 2,1,3
#??#???????????.??? 14,2
??????#?.#?#.????.? 7,1,1,2,1
.??..???????? 2,1,3
???#??#?#?#?.. 1,7
????#??#?#?#???####? 4,13
.#..?.???# 1,1,3
.#?##.???.????#. 4,3,2
.??#??#?????????# 6,8
?#?.??#?#.???? 2,4,1,1
.??##?#????.?? 5,1
??#?.???##???? 4,3,1
#?#?#?..?.?#? 6,1
?.#??.??##??????? 1,1,1,8
?????#???????????#?# 1,4,1,2,1,1
.???.?.????#?? 2,1,1,3
..?#?.#?#??#?.?? 3,7
???#?#?##?##???#??? 1,1,12,1
?.??.???#. 1,1,2
???#?###????# 1,1,5,2
?.????#?????#??##? 7,6
??#??#?.??? 6,2
???#??.???????#? 4,1,1,1,2
##?##?#??.??#.#? 8,3,1
??#????##.?? 9,1
?..???????? 3,1,2
????##?????#?#?#??.? 3,7
.?..?.???.?#???????? 1,1,2,6,2
?.?#????#.??? 4,1,1
#??#??#????.#?? 8,3
????????.??.##?? 2,1,1,2
???.???#??? 1,5
?????#.#?? 2,1,1
??#?.?#?#?????.#?? 2,4,3,1,1
?#???.???.##? 3,2,2
???#?#???????.?. 4,6
?#????###?.???#?#??? 8,9
.?????????? 8,1
?#???##?#?? 1,2,2
??.?##??#??? 2,2,3
?????#?#???#?. 7,2
#??????????.#.?..?#. 9,1,1,1,1
?.?##?#???.??#??? 1,6,5
???.??#?#?#.#??.. 3,7,2
?.???##?#.#? 1,6,2
???#???????.?#????#? 1,2,4,7
??#?#???#?.? 8,1
?.?#.?.#???..? 1,4
#.?.????#??###.???## 1,2,6,2,2
???????.????. 5,4
??.#?????#?#????#?? 1,10,1,3
???#???.??? 3,1,1
?????.#??#.? 1,4
???#?.?#???????? 3,4,1
.???????#?????.?#?? 4,4,1,2
?????????.?.#???#?? 7,1,1,2
###.?#???#. 3,6
...##?##?#???? 5,5
?#??#????.? 1,4,1
?.?????????#? 6,4
.?????###?#? 1,6,2
.?????#???? 5,1
??????.???????. 1,1,1,2,1
?.##?#??##??#??##?# 4,11
?##??#?.#??.?### 2,1,1,1,3
?.?.??????. 1,3
.?.?.?#????.??#?... 1,2
?.???#?##???#.?.? 1,5,1,1
.?..?###????#??????? 12,1
?#???#.?#.?# 2,1,1,1
??..#????#?????..?.? 2,7,1
????????.?????????? 8,3,1,1
##???..??? 2,1,2
??#???#???? 1,2,1
.????#??###.??# 10,3
??????.##???????#? 5,5,3
.##???????####.?. 3,9
.#?#???##?.???#?#?? 3,3,7
????#?#?????.?#?? 1,10,3
???#??.#.???##?.#? 2,3,1,1,3,1
.#?.??????????#????? 1,13
??????.?#??##?#?.? 3,1,5,2
.??.?#??#?????????.? 1,5,2,1,1,1
??????#.?? 2,2
.#?##??#?#??..#?.??? 5,5,1,1
????.????#??# 1,7
#????...?????#? 4,2,1
??#???.????#??.??. 3,1,2,1,1,1
.?????.????. 1,1
??#???#?.? 1,2
?.#???#?????? 1,7,1
.??##?.#?.??#??#???? 4,2,7
#??#?#??????.#?#?? 1,5,1,1,1,3
.?#??##????...??##?. 9,4
?##??????#?#?##? 2,2,3,1,3
.?#??#.#???? 4,1
??????.?#???.?#.#??# 4,3,1,1,2,1
??????.#???.??? 5,1,1,1,1
?.??????.#? 1,2,1
?##?.????. 3,2
??.???????#???#? 1,1,2,7
??#.#?#??#??.? 2,7,1
??#??#?.?#?. 6,2
.?#??????? 1,1,1
.#??.????#?#.? 2,2,3,1
##??#??.?? 5,2
?#?#??#??#### 7,4
???###???..? 8,1
##???????. 2,1
???#???.?????.??# 1,4,5,2
?..??????????##??? 1,1,4,4
?#??????##??..??. 1,7,1
.?#??.???#?#???#?.? 3,8
?###???#???####. 8,5
?.????#?#??????????? 1,1,1,9,1,1
??#?????##?#??. 1,7
?####????#????##???. 7,3,5
????.???#? 2,5
??#????#???..??#?? 1,2,6,5
.?.???#?..???? 1,4,3
#?#????##???. 3,1,4,1
??.#?????#?. 1,8
???????#??#? 3,1,1
?#?#??.?.?.????.. 6,3
?#?????????? 2,2,4
??#?#??#????????# 12,2
????##???.????? 1,5,3
#?##..?#.? 4,1,1
??.#???.#????#? 1,4,1,1,3
??##?????#?### 1,4,1,3
??###??.?#.#????#?. 7,2,2,1,2
????##????.# 6,1
??????????? 2,2,2
???.???..?.?#.?..?? 1,1
???#???#.?.#??? 1,1,2,1,1
#?.?..??.???????. 1,1,1,2,3
?##??????#??? 4,1,4
???????##????? 1,8
##?????#????.#?? 8,1,1
.#..#?#?#.?.##??#?? 1,1,3,1,6
???##??.???? 1,3,1,1
?#????.#??? 5,3
?.??##??.?#??#?.??.# 6,2,1,1,1
??#?#?.??.#??...? 3,2,1,3
?????#??.. 3,2,1
.??#?...?#?#?. 4,5
.????#???.???. 6,3
????.?#???...?.?. 5,1
??.??.?###???#?? 1,2,7,1
????.?.?#?# 1,1,3
.???#?#...??##?#? 6,6
###???.??.??#?????? 3,1,1,2,1,1
?#..???.???# 1,3,2,1
##??#????. 2,3
##??????###???##..# 7,8,1
?????#????..???#???? 9,4
.?#??##?.?##??#. 2,4,3,1
?#????.#??.????#.? 4,1,3,2,1,1
#?.#???.??#?.??. 1,1,1,4,2
?.??#??#?#??.?#?. 9,1
.#???#.???.?#?#..?. 1,3,3,1,1,1
?????#?.?.?# 3,2,1,2
.???????.??## 1,5,3
??.?????#.??? 1,5,2
??.????##..?#.??# 1,3,2,2,2
.#????.?#???..???? 5,5,2,1
????#?##???#. 5,2
?.?.????#????#. 1,1,1,2,1
#.?#.???#???##?# 1,2,10
?????.?.???????????. 1,7
.??#??.?.????? 5,1,1,1
???????#.. 4,2
?.#??????.??#?##??. 5,6,1
.????????????? 3,1,1,1
?#????????.?? 1,2,1,1
#.????.??#..? 1,1,1,1
.?#.?.???????? 2,1,4
??#?#??#?#????..? 1,1,1,8,1
##??????.#.? 2,3,1,1
??#???.??...??.? 1,4,2,1,1
????#?#?#..?.????. 9,1,1,1
????.#.?#??#???????? 2,1,10,1
?????#.??????.. 1,2,2
??.?###..#???? 4,3
#???#??.???????? 6,4,3
?#????#??? 1,3
??##?.?#?#????.??. 3,5,1,2
##.?.###?????.?#?? 2,5,3
??.#??????#??????. 8,1
?#?#???.??#?????.. 7,7
##?...???##???##??? 3,12
.???#??????#???.???# 5,5,1,4
??.??..????? 1,1,2
??????????.??? 5,2,2
#????.???? 5,2
.?#?#????# 7,1
#???###.?##?# 1,3,3,1
???#???.#.?# 3,1,1
#??????#?#?#??????## 1,7,1,6
?????#?#?? 6,1
??#?#?.??????#?.??? 6,2,1,2,1,1
????????#????##.?#?. 1,11,1
?.?#?????? 1,2,1
??????##??.??????. 1,1,4,4
??##???##???#.#?.?.# 11,1,1,1,1
?.?.??#??..??##?#. 1,2,6
#???##??????? 2,3,1,1
#?..????#??#.?### 2,2,3,1,4
??#???#??????#.????? 12,3
?#?#??.#?? 4,2
??????#??.???..?#?# 7,2,3
.???#?..?????#?.. 5,1,1
?.?????..?????. 2,1,1
??#??.??##???.????. 2,6,2
.????????.#?? 1,6,1,1
.???????##???? 8,1
.??##?.?????#?? 2,4
.??????#????###?. 1,4,6
?#?..###??#???##?? 3,4,1,3,1
??????????##?????. 2,3
???#????#?#?# 1,6,1,1
#?##?????#????#???#? 5,1,1,9
#???#?#?#????????? 1,1,7,1,2
???..#?.?#?#.#?#??? 1,2,4,3,1
?#.???#???##?#??. 1,1,6
????##?#?#?.?.? 2,3,3,1
??????##???? 1,9
??###???.?#?? 5,1,2
#.#?.??.#? 1,2,2
?.??????.?.????.?... 2,2
????#??????.? 6,2,1
?????.?????#?.#??? 1,2,7,1,1
.?#?#???????? 3,2
.?????#?.?.?#????? 6,5
#?#??..??##??. 1,2,1,4
.???#..??#?#? 3,5
???#????#?.???##???? 10,1,4,1
?.?#?.??..???? 1,2,2
???#??.?#?.??? 6,1,2
.????#???##???????? 6,3,4
#???#?.???????###?? 1,1,1,1,1,6
??#???.?.?.??#?? 3,1,1,4
?.??##?????.?.?#?. 1,9,2
??????.??#???#.#.. 4,6,1
??##??.??# 4,1
.?#???.#???#?## 3,1,1,1,2
???#???##???#. 3,6,1
#????..???#. 3,1,2,1
#.??#??#??#?? 1,2,1,1
?.##???#?. 1,2,3
?????????#????.?. 14,1
??##???#???.??# 8,1,2
..?#???#?.????. 2,3,1,1
?.??????.???#??.. 1,1,5
??..#???#????## 2,5,2
????#?#???#?#??#? 2,2,8,1
????????#??????? 1,3,7
#?#?###???#?? 1,9
????.????.?#????#?# 4,1,2,4
??#.?#?#????? 3,2,2,2
#??#??.?.?#?#??#??? 6,1,6
.#??.??????? 3,2,1,1
??.#?#.????.??? 3,4,1
??..#?.?#.?#???? 1,2,1,1,2
??#??#?????#?.??? 3,4,1,1,1
.??.???#???..?? 1,5,1
??.????..??.#???#? 1,3,1,1,2
????###???#???? 1,9,1
.?##????.?##? 4,1,4
?.?.???.#?#?? 2,4
..??#???#??.#. 8,1
?????????#? 4,1
?????#???.??# 6,1,3
.????.????#. 1,1,2
??.????##?? 1,6
?.#??.?????#?## 1,3,1,6
??#????????#.???#??# 5,1,1,2,4,1
?#..?#.?#? 2,1,1
?..?#?#?#?#??#???? 10,1
?#?.???.?????? 1,1,1,4
?.?.??#?.????.??. 3,2,1
??#?#####???#?????.. 10,1,1,1
.???#?????#??? 2,3
#??#???.?????? 1,2,1,2
#.#.?.???#??? 1,1,1,6
..???????. 5,1
?#?????#.?#???##?##? 5,2,3,6
??#??#???#.??#?#?. 1,8,6
?#??..??.. 2,2
?.##???.###? 2,1,3
????..??????#? 1,1,5
?.????????.???.?? 5,2
??.?..???????? 1,2,3
.?.##?.?.?. 3,1
??????#??.????.? 6,1,1,1,1
..???#??#..#??##?? 4,7
?#??#?#.#????.????# 4,1,3,5
.??.????.? 1,3
?#?.??????#??##? 2,1,3,5
??##.???????#.??? 3,2,5,1
??.???????#???#? 1,1,1,3,1
?????..???? 2,1,1
?.????.?.??#?????? 3,4,1
#?#?.?..#?????????#? 3,1,1,9
???.?#???#. 2,1,1
?#???#??#?????#???# 2,11,1
?#.??#????#??? 2,1,3
##?.?##??.? 3,4
???#?#???..?#??? 5,2,1,1
.#????.#?#??#??? 3,6
..#??#???? 1,2,1
#??.???#?##.?# 1,7,1
??.???.???????.??? 1,1,1,3,1,2
.??.?.????.#???.?#?# 1,1,3,4,1,1
.???????##?.? 5,2,1
?.??????#?? 1,3
???.#???????# 1,1,5
???#??#.#???? 1,1,1,2
??.???.???????#??? 1,1,1,1,6
.???#?.???##? 4,4
???.???##?##???.???? 10,1
??###???#??????#.?? 5,5,1,1
?#??????#?#?.??? 2,8,1
?###??#???????#. 9,1,1
.???????#?###??? 1,1,1,6
?.?????##??#??#?? 1,13
???????##???.??#??? 11,2
.???#?#?.??.?? 6,2
?????????#####?#.? 1,11,1,1
??#??.?????##?#???? 1,1,1,5,4
?#??##?.???# 2,2,4
#.?????#?????? 1,1,5,1
.#??????##.? 3,1,2
???##???..??##.??. 6,3,2
??.??.#?#????.?????. 1,2,5,1,3,1
?..##?????.#??##?## 1,3,1,8
?.????#???.??? 1,4,2
.???#?.?.?.? 4,1,1
.??##??#?#?????#??#? 14,1
.?#???..???????#?? 4,1,6,1
???#??.?????..#???#? 2,1,4,6
???.#???##?#?.?.#. 1,1,3,5,1,1
???..??#?#?????????. 1,3,10
???????#??.??#?#?? 3,1,1,3,1
??.?.????. 1,1,1
??.??.#??#? 2,1,2
??#????#??#??# 4,8
?#???#???#???? 2,7
???#??##?????? 1,7,2
??????.??##??????#. 2,11
?#???##???##? 3,8
.?#?..???.??????##? 2,2,8
??.?##?..#?###?...? 3,6
???##???#????? 11,1
.#???#????#?#?????? 1,1,14
?.????#?.???######?? 3,8
?.??????###????.? 2,9
?.#.????.???.? 1,3,1,1
????.??..?# 2,1,2
??.?????.????#? 1,2,2,5
?#????????# 5,3
.??##????????? 4,3
#????????? 2,1,1
.???#??#???#?...? 9,1
.??#?.?.##?.? 2,3
??.?#??#???? 1,2
.#????????????. 4,2,4
?.????????????#? 1,1,6,2
???#.??#??? 2,2
?..#????#??#? 1,1,4
#???###??..?.# 9,1,1
?#?#??????? 3,1,2
???.??????#? 1,1,2
.#????????#. 2,1,1,1
??..?#?.#?????#.?#? 1,2,7,1
.??#..#???? 2,4
?#??????..? 2,2,1
?#??#?.???????? 3,1,3,1,1
?#??#?#?????#??..?. 7,3
??.#.?.#??##??#?#. 1,1,1,5,1,1
?#.????.?? 2,1,1
??#?.???#???. 3,4
...???.??????#.#?#? 3,7,4
..??#?#????.???? 6,1
#??#?.#??#??####?. 1,1,1,8
????#.#?#?.??#.. 4,1,1,2
?????#?#??#?? 4,6
.????#???.?????.???? 1,4,1,1,1,4
.???#????? 1,1,2
???.??????. 2,5
#?#???#??##??. 11,1
?.?????.?# 2,2
.?????????#????????? 8,3,5
??????#??#?#? 8,1,1
##?????#?. 2,1,3
?????###?.??????? 7,2
??#?????.?#?.????? 1,6,1,5
.?..????#????#.???? 9,1
??.?????#.?.?? 1,1,1,1
??.????..#??.. 1,2
.?#.#?#?##???# 2,1,5,1
??..???#?????.?? 1,1,1,3,1
?#?#??#?#??????????. 2,9,1,2
???#?????.#..??#???? 8,1,4
.??.???#?????. 1,1,3,1
?????.#??# 2,1,1
.??#.????. 2,3
.##?????.?# 2,2,2
?#????#??#??????? 1,11
????????#??????.?.?? 8,1
??#?#?#??###?##???#? 13,1
??#.??#???#? 1,1,2,4
???##.???????. 1,2,2,4
?#?.?????.??#.? 3,1,3,1
????.???..#?? 2,2,2
???..??????..?.?#?# 2,2,1,4
??????#??#.??#??.. 4,2,4
????#.???#???.?#??? 5,6,2,1
??#??.???? 3,1
??..#????###?????# 2,2,1,7,1
?##??#??#??# 5,3,1
???#???.???.#?#? 4,1,1,2
.????##.?.?#??? 6,1,1,1
?.??.#.?.?.# 1,1,1,1
?..????..? 1,1,1
??.??.???# 1,1,4
.?#???????? 2,2
?##.???..?# 3,1,1
??#??#????. 2,3
????##???#?.?.#?? 9,2
#.?.##?#.??? 1,2,1,2
?#??#??#??#.?? 7,1,1
???.##?.???.?#??#? 2,3,3,1,1
??#?.###???#??# 1,1,10
?##?.????.?? 3,1,1,1
??????.?????#????.?# 2,1,2,3,1,1
?#??.???###.# 1,1,3,1
????.????. 1,1
?#???.?????? 2,5
?????#???????? 1,5,1
????????..???????? 1,1,1,1,4
.#?????#?????? 9,1
?????#?.?#??#?? 1,2,3,2
???#????.?#.? 5,1,1
#???##?#?.?.?.????# 1,7,1,1,1,1
??.??#?????.???? 1,5,1,1,1
?.????#??????#? 1,1,2,5
..??????.. 2,2
.????#???.??#???#? 7,5
?#?.?##??????.??#? 2,2,3,1,1
???.?#?????? 2,6
?#?#?#.?????.??. 6,1,1,1
?.??##..???#?##??? 3,7
?#????#?#??..? 2,5
??#???#??#??.?? 3,6
?.??????#?###???.?? 1,1,6,2,1
???????????#??? 3,2,2,1
#???..????.#.#?? 1,1,1,1,3
#?.?????.#? 2,1,2
.??.????#?? 2,3
#..????????????.? 1,4,5
#.??.#????#??##?.? 1,1,4,1,4
??#?..??.?? 4,1,1
??#.?#????????? 1,1,5,1,2
.??????#?##???.?? 1,5,1
?#.#??...?#???#? 2,1,1,4,2
#??#?????..# 1,4,1,1
?#.???..?? 1,2,1
?##??..?##???.#.? 4,5,1
??#???..#. 5,1
?.???.#??#.???.? 1,1,1,1,3
.???.??##?#?. 3,3,2
??.#.?..?? 1,2
.?#??#???# 6,1
##????#.??# 7,2
##??.???.?##? 4,1,3
???#?#?..??????# 1,4,1,1,1
??.???????.?##??? 1,3,3,6
.?#?#????#??#??? 4,4
??.?#?????..???# 4,4
.??.??.???#. 1,1,1,1
.?????.???????? 3,8
?..?#..?##?.??? 1,1,3,2
???.#??..???. 2,2,2
????????.?.?#??.? 3,1
??##?.????#? 5,1,2
.???#.???. 4,1
?#??.?.?.?##?? 2,1,5
?#?###.#???????#.# 6,2,3,1,1
??????.??#??.?### 1,4,3,3
??????#??..????. 5,3
???????#??..??? 8,1
??#???#????#?#??.??. 14,1
??#..??????#??##?? 1,1,9
?##??#??.#?????##.?. 7,2,4,1
.?##????.#. 3,1,1
?.????.#?##?#. 1,1,2,1
?#?#..????#.? 3,2,1,1
????#?###?..##?? 1,1,4,2
?#..???????? 1,1,1,2
???????#????? 6,1,1,1
????.#??#?.. 3,1,2
.#?.?????#???#? 1,1,7
?#??##???#.??? 7,1,1
??..????#? 1,2,1
.?#???????? 3,1,1
???.????.?.??? 1,3
???????#????.? 4,5,1
.????????#.??#?????? 1,1,1,1,5,1
????#?????#?#??##?? 4,9
???.?.#?????? 2,3,2
?#???.#.??..? 1,1,1,2
????#??????????#. 9,2
???.????#..?##. 1,4,3
????.??.????.?? 1,2,1,3,1
?###????#????#?## 4,4,4
??#????????#?? 1,3,1,5
??#?????#??###..?? 14,1
????#.?#.??.?### 2,1,2,1,3
?.?.#?.?#? 1,2,3
#????????###..?.. 4,2,4,1
#????.??##?##?# 1,2,1,7
???????.??.??? 5,2
?#?.##????.?#. 3,2,2,1
?#?#??#??#??.? 7,4
??.???#????. 1,7
?.?#.????##?????.# 1,7,1,1
????##????? 8,1
??????????##???#?? 3,12
...##..??#???#? 2,6
?#?????.??. 2,1
???.?????. 2,1
.?##???????##???. 3,2,2,2
??.????.?..#?.... 4,2
?##????????##???.# 4,1,6,1
??#??????#?#?? 1,8
???.#?????#??.??? 2,9,1
.##?.??..????# 3,1,1,3
?#?.?#???#?.???? 2,6,1
?.?????.????#? 4,2,1
##?##?.????##?.? 5,7,1
???????????.# 2,1,1,1
#???#???.#.???# 1,6,1,1,1
??????##???.?.?# 8,1,1
?#???###.??? 2,4
#?.#?????.?#.???..# 1,1,4,1,3,1
?????#.?.??#?# 1,1,5
??#????????.???#??? 5,3,2,1
.????.??##..???? 3,3
.#.????#??#??? 1,8,1
..???#???????.. 4,4
.?#?.??#?????.?????? 3,3,3,2
?????????#? 5,2
#.????#.????##?.#? 1,2,2,6,2
??#?#.?.#? 3,1
??#??????#??.?? 3,3
..???..???? 1,1
???.##?.???? 2,3,1,2
??????#?#?.### 7,3
?????..??????.#??#? 3,1,1,1,2,1
?#?#??..????#??. 3,5
#.?.#????#?? 1,2,2
.???#...?# 2,1
.???.???#???????.?? 1,1,1,5,1,1
??#??#???#?..? 5,3
#??????##?? 3,5
#??#.?#???####??#??? 1,2,2,1,5,2
???#?????.?????????# 5,1,1,1,1,1
?#?????#??? 1,1,2
???#?#?.??#???? 2,4,6
#?????.?????? 1,4,1,2
???#???#?????.?? 11,1,1
##??????????#.? 3,1,5
#.???????#???.???. 1,1,2,1,4,1
?#???..###? 2,3
?#?.??????? 2,1,1
???.?#?#?? 2,2,3
??#?##??..#? 1,4,1,2
?#####.????????#? 5,9
?.??.?####????? 1,1,8
???..#????????##. 1,11
?.??????????#????#? 11,4
.?#???#?????##?. 2,2,1,2
.???????.# 1,2,1
.???#????#???#? 3,9
..?.??.##??#. 1,5
??.#???##?##?????# 1,1,13
?##???.???? 5,3
??.#?????.??? 1,2,1,1
?.?#?#???#.???#??#. 1,4,1,1,1,1
#?.????#?..#??? 2,1,3,1,1
??#??##??? 4,4
.????.?.??## 3,4
?.?????.?#???? 1,4,2,3
.??????????. 2,1,1,1
?#?????..#?##? 1,1,1,3
???.?????..#? 1,1,1,2
????#??????.#?#.? 1,2,4,1,1
??#?.?#???#?#??#?? 1,1,2,4,1
??????????#?# 6,5
????#?#?#? 2,5
.##??.#?????.#? 2,1,1,3,2
#????.???#? 5,1
?????##????#.??#?# 4,2,5
.?????#????# 2,1,3
.??.#?????? 3,2
????##???.?.???? 5,1,1,1,1
.?##?????#?. 2,4
?.????.??#???.?. 4,4,1
??##??#??..?? 5,1
?#???#?#?.?.#??#?? 1,6,1,2
???????#????#.?# 9,1
#??.??#?#??. 3,7
##??????#.?# 2,4,1,1
#??#?#??#???#??#. 6,7,1
??????????.? 2,2,2
??#???.???#?#?#???? 2,1,4,1,2,1
..?.#.#??.?# 1,1,1,1
.###?#.###.? 5,3,1
????###?#??.#. 1,6,1
?.?#?#??##?????##?# 1,4,11
.??????#?????.# 1,1,5,1,1
.???????##??#.??. 12,1
??????????? 3,1
..???#?##?#?#??? 2,2,5
?????.???? 1,2,1
???#??##???.???#? 11,1,2
??????#??? 1,3
??#?????#? 4,1
.?#???.?#?##??? 4,2,5
?#????#????.?#?#?#?? 1,3,1,2,1,3
?....?#????#??????.? 4,4
?#?#.????????##?? 2,1,5,2
.???#??..?? 4,1
????#??.????#? 2,3,1,3
???####?.?#???##? 5,1,2
??#.#???????? 2,1,1,1
.?#???.???.??#?? 2,1,3,2
???#?#???####???? 4,1,9
??..?????###????#?. 1,11
..???????#?#???..?#. 13,2
.?#?##?????????.??? 5,4,1,1,1
?????.???.#????????? 3,1,3,4,2,1
?????????#???#? 1,5,4
??#???##.?. 3,3
????#.???#?##?#?.?.. 1,1,1,1,8,1
??#??#?##????#???.?? 12,2
??#????#??# 7,1
?.?#????????? 1,4
????#...?????#?? 4,2,2
???#????..?#? 6,2
???.?#?##??????????? 3,5,3,4
?##???#??..?#.#?? 2,1,3,2,2
?##??????.#. 9,1
.?#????###.???? 8,1
???#?###????.? 4,3,1,1
?.????#???????????? 1,1,1,2,6,1
??##.??.?#.??#???#?? 4,2,1,2,3
???#??#?.?.?#??##?? 6,7
??#???##??#.?.?.?.#? 8,1,1,1,1,1
.#?????#?? 1,6
?#?.??.#?? 2,1,3
.??#?#?????#..#??. 1,1,1,5,3
?#.???.????#??. 2,1,3,1
..#?????.?.?# 4,1,1
??#??????#??#??? 3,7,1
?????????????##? 3,8
?.???#??????#.#??. 1,3,4,3
?#.#????#????? 2,4,5
????????????.? 2,1,3,2
.???#??#??.? 3,3
?????.??#?? 2,1
?????????????#???? 2,11
?.??#??#?.?.????? 5,1,1,2
?##?..#???????.? 2,1,2,1,1
??????..???.? 4,3
.#???#?#?##??????? 1,1,7,2,1
??##?????#?.???#. 6,4,2,1
??????.?..#????#? 1,4,1,1,5
?##.????#??. 2,5
.??????#.?. 1,3,1
?.##?????..? 1,4,1
?????????#? 1,2,1
???.??#??? 1,1,2
????????#.? 8,1
.????#???..#?? 6,2
??????.#?.?.?#?? 1,2,1,3
???#?#??.?????????. 6,7
???###?..??#???? 3,6
...???#?????.?#?. 8,2
?#?.???#?.?.? 2,3,1,1
#?#?#????.#???? 6,2,2,1
?#?????##?.??#?#?.?? 9,1,1,1,1
??????????#?#? 1,1,1,3
#????.??.?#??. 5,1,2
???..#??????### 1,1,1,2,3
???#.#?##??##?##? 3,1,3,6
???????..?? 4,2
?#???..#??#? 1,1,1,1
?..?#?#.?.#??#?? 2,1,1,3
#??#?????#????.?? 4,3,2,1
??#?????.?#.? 5,1,1
.?#??.#???#?????#?? 4,1,1,1,1,1
?????????#? 2,4
..?.?#??#?#??.??? 9,1
.??.??##?. 1,5
..??#????.?..??? 6,1
?#????.????#? 4,1,1,3
?#??.??#?#????# 2,1,8
?#.?.#.#??#??#?#?## 1,1,1,12
.??#???????. 2,2,2
??.##?.??#? 1,2,4
???????### 1,1,5
.?.?##????? 4,1
??.#??.?#..#.?????? 1,2,2,1,2,1
?#?#??????#?##?? 8,1,2,1
??#?.??.#. 3,1
?#???#?.?.??.?#..?#? 7,1,1,1,2
.?????.##.. 2,2
??.?????.??.#?#??. 1,3
?#?.#??#?..?? 2,4,1
??##?#??#?#?. 5,3
???#....????. 4,3
#?.#????#?#?#?# 1,1,3,1,1
#.#??#?.#.?????## 1,1,1,1,7
?.??????#??#???#?#? 1,1,1,12
?.?.????#???. 1,3,4
.?..??##??..??.??? 1,6,2,1
?#????????#??? 3,2,4,1
??.????#?###??? 2,7
..?#?????#? 2,1
?..??????.#?..? 1,6,2
?.#.?.????? 1,1,3
???#???????????#?#?? 2,3,7,1,2
?##??#????##?..#???. 12,1,1
?????????.#?????. 5,2,1,1,1
??#?#?.??##?#??? 3,1,3,1,1
???#?????????. 3,5
?#?#?##????.?#?? 8,1,1
?.???#?.?.? 5,1
???.#.?#????????.. 1,1,9
#?.???..?????#?.# 1,3,2,2,1
??##?.?.???##???? 3,6
??#??#???? 2,2
#????#?#.. 4,3
?#???????????? 2,5
#??????...??#??#???? 1,2,2,1,2,5
.?#?#.????#.??.? 3,1,2,1
??#?#??.?#????? 5,1,1
????????.?#? 1,1,1,1
???????#?##?#?????#. 1,1,9,1
?##?.?????? 2,3
??##???#????#?.?# 11,1,1
??##?#?##?????#?? 8,4
##??#????#?#.?? 2,1,1,1,1
#????????#????#??.? 4,5,2,1
???#???##???#?.?? 2,6
?#?.??#?????...#?. 2,7,2
????..?###????#?? 2,4,2
??#??????#??. 2,2,1,1
????#.?.#?.#????? 1,2,2,2,1
.#????#???# 3,5
.#?##???#??#?.# 9,2,1
????##??.#.? 4,1
#.?????####??.?.???. 1,11,1,1
?#??????#? 2,1,2
??#?.?..?? 2,1
??.#??.?.? 1,1,1
?##??#.?#? 4,1,1
?#?######.?.## 8,1,2
?..#??#.?#?#?.#?? 1,1,1,4,1
????#??.??##?????#?? 1,5,8
??.???????? 2,1,2
???##?????????#.?#?? 7,7,1,1
.?.?????#???. 3,1,2
?#?????????????#### 1,1,1,1,2,4
??#?.????### 3,2,3
?##?.????##???? 3,4,1
#????????? 2,3
?.??#???.??##? 1,5,1,2
???##???###??.??.? 1,10,1
???#?????? 2,4
.##????????? 4,2
.?.????#?#? 2,4
???.???#???????#???? 1,11
.?#??.??##? 1,3
????.??????????#..? 2,7
??#?.#??.?#???##??#? 1,1,1,8,2
?#?.????.?#??? 2,2,2
????????????????.?#? 5,1,1,2
#?#.?.???????#?#??? 1,1,1,10
.?#??#.?????###?? 3,1,1,5
?.?#?????#?#???? 1,2,1,5,1
??#???.###??..??.? 3,5,2
?##?#????.????#??#?? 7,8
?.?..????#????? 1,1,1,1,3
??#?##?...???#????? 5,4,1
????##???##?. 1,8
??.?#?#?.?.????? 1,5,3,1
?????.????..??. 2,2,1
.??.??????? 1,2,3
..#?#??????#???? 11,1
?..?.???#??.?#??. 6,2
????.#?????????#???? 2,1,11,1
??#????????.??.?.?? 1,7,1,1,1,1
???????????.? 5,2
??????.?##?. 4,4
.???.???#.? 1,3
??.?###????#??????#? 2,15
?#????##?? 3,3
??.????????????#? 2,2,1,1,2
?.?#.????.?. 2,4
?.#???#??? 1,2,2
???.?.?#.. 3,1
?#???????????????? 4,1,1,1,2,1
.???#?????##.? 3,2,2,1
??#?.##..#??? 1,1,2,3
#?.?###????#?.?? 1,9,1
..#??##?##?? 1,2,3
???#???##.??#???? 8,5
.???????#??????????? 2,1,3,1,5
?#?#???#.??#?????#?? 3,1,2,5
?????????#??#??#. 1,3,1,5,1
??.#??###?.?.?. 1,7,1
?##????..?.??.. 6,1
#???#?#??????#??.? 7,1,1,3
?.????#??#???.??.?# 10,2
??.?#?????#?##??.? 2,13
?#??#???#?#?#.?????? 12,2
?#??#????????? 3,6,1
??????????#?#?##?## 2,1,11
.?#.???????#?#???? 2,11
..?#????##??.. 4,3
???????#????? 1,1,4,1
???#..#?#?? 1,1,5
.?..?.#???? 1,4
????#???#?????#?? 6,1,3,1,1
??..?.???.?? 1,1
?#???.#??#????.? 2,1,1,2,1
?#?..##??#?? 2,5
????.??##?#??.? 1,5
??????.#?###.?? 1,1,1,3,1
?##??.?#?????? 5,2,4
????????????????.? 2,1
?#???#?????#???#?# 3,2,3,3
.????#???.??.# 1,3,1,1
???????????? 5,1
.?.#???????? 2,1,2
??#???.??????#?. 3,1,1,6
??.?#???.##??#?# 1,3,7
?..???#??#?????. 7,2
???.?.????#??#. 3,1,5
?.????##??##.?.??#?? 1,1,3,3,1,3
?????#???.#??#?#? 3,1,2,2,4
#.???????.???#??? 1,1,1,1,2
#?#?.????.?? 1,2,2,2
#????.?#.#?.??.? 5,1,2,1,1
?#??.???#?#.#?.?? 2,6,1,1
??????#??.?.#?. 1,1,3,1,2
??.?...#??. 1,1,2
.#?.?.??.?.??#.???? 1,1,1,1,2,3
.#..??##?.? 1,4,1
???#????#?#.??. 1,3,1,1,1
??#??.?#??? 4,1
?.??##??.??. 5,1
??#???..??????? 3,1,1
#.???##????#?? 1,4,4
.#??#?#??.?#???? 2,4,6
????????##????? 2,2,7
?????#?#.??? 1,1,3,1
??.#????##?#???..#?. 1,11,1
???#?#???????????? 3,9
?#.#??#?.?#??? 2,1,1,5
??.??.???? 2,2
?????#?#??##? 8,3
?????.????#?#???? 2,1,6
?.???#?????.???? 1,1,7,1,1
.?.????####??#??? 1,1,1,7,1
???.???.????? 2,1
????.????? 2,4
??#?..????.. 2,1
?#?#.?##?. 1,1,4
..######????????#?? 6,6
?#.???###?????? 2,8,1
?#????##?.???#???? 8,1,4
??????.?.#????#?#? 5,1,8
????#?#????.#???.? 1,1,2,1,3,1
.?????#?#???..?? 5,1
?????##??????##?##. 6,10
????#???#???#??# 5,1,5,1
??????#?????#?#?.?? 13,1
??#???#?????? 4,1,1,1
?.?.?????#??#?? 1,5,2,1
?#.???.??.?#??.?. 1,1,1,2,1
?????##????? 6,1,1
?.##??#####??.???? 1,11,1,1
????#?????. 3,2
??????#.??#??? 2,1,3
#?.?.???.??##???# 2,3,4,1
.????#.??#???..????? 5,4,3
.????.?.#????..?? 2,1,2,1,2
?..??#...#?##.? 3,4
#.?????#.?.???#??#. 1,5,1,7
.?#??##???? 5,1
?.?????#??#? 1,3,1,2
??#???.??.?#???? 2,1,1
.?#?.?.?##?????# 1,1,5,1
??#.???.?###??? 2,2,6
????????.???? 1,2,1,2
#?????.?.?#???. 1,4,4
?.??.?#???# 1,1
..????????#???????? 10,3
??#???.?.???. 2,1,1,1
??#?#???#?????? 10,1
??#?#??#??????. 5,7
??#??????? 2,1,2
?????##?????.. 1,4
.?#??.??.#?#?#. 3,1,3,1
?.?????..? 1,1,1
.????.??#?.?###???? 2,1,2,6
.##???.??.###?????# 3,1,1,4,1,1
?..?#??##???#?#??? 3,10
??????##?#??#?? 4,9
?####?.????###?????? 5,8,1,1
?????????? 1,1,1
??.?????.??#??????# 1,1,1,2,1,3
#?.##??.##. 1,3,2
????.?#?????# 1,1,1,3
??.?#.#??..##???. 2,1,2,5
??????????.?#??#???# 1,1,1,1,6,1
???#???#?#??#???. 9,2,1
?#???????????? 8,1,1
#?.?.????????#??###? 1,1,12
#??##???#? 5,1,1
?????.?#??????. 1,1,4,1
??#.#?#?.#?.????## 1,1,2,1,6
?.?????.#. 1,1,1
?????#????#?#??.#? 1,1,8,1,1
??##?.??###?.??? 1,2,1,4,1
?????#???#??..???.? 2,8,1,1
#.#.??.?.??.???#? 1,1,1,1,4
?????.#?.?.?? 1,1,1,1
.??#??#?.##???###? 7,8
?????????##??###?.? 3,11,1
???#?.??#???.??.? 3,4,2,1
?#??#??#??..?..?? 9,1,1
.#???????#????? 1,1,1,5,1
?????????..???????# 2,2,1,1,5
?##?.??#??? 3,5
#??#??##?? 1,3,3
.?.?.??????##?#???? 1,2,7,1
??#?????##?#??.??? 2,5,3,1
???.....#?.?? 1,2
?#?.#??#???? 1,6
??#.??#?#??#??? 2,4,3
?.#?#??#.???# 6,1,1
.??????#???.#.??##.. 8,1,4
??.???#?.##???#? 1,1,2,7
????#??#????????# 5,6,1,1
??#?.?#.#???#?? 3,2,2,3
.#.?#?##.#..?????? 1,1,2,1,1,3
??##.??...??. 4,1,1
#??#???.?#??? 2,1,1,5
?#???#?.?? 6,1
#??.#???????.?.? 2,5,1,1
??#?#.???#??.?? 1,1,1,5,2
????#????.?. 1,7,1
?.?#.?.?#?. 2,2
..??..?????.?.##??? 1,5,3
?#?..#?##? 2,4
????..#????????#?#.? 3,12
???.??????#?????#?? 9,2
????????.# 3,1
??????#???#? 3,3,2
?#???#????.??# 3,4,1
.?????????# 3,1,1
?.??#.??????#??? 1,1,1,5
.???..?#.??? 3,1,1
#?..??.?.??????# 1,2,1,2,2
?????????? 5,3
??#.??????#. 1,1,7
..???.?????? 2,1
?#????#?#???????#? 4,5,5
??????????#?####?##? 2,15
???.?????? 1,3
?#.####?#?#??#..# 2,4,4,1,1
????#???#.?.?.? 6,1,1,1
??#?#?????.. 3,2,1
####?????####.#????? 13,1,1
????#?????.??.#.?# 1,2,1,2,1,2
#.?????#???. 1,2,3,1
???#????????.???#?# 10,5
#???????##? 4,3
?#????.????..???#. 6,3,2
..#?##?.?.. 4,1
?#??.#?#??? 1,3,1
`
  .trim()
  .split('\n');

if (runs[0])
  console.log(
    'part1 sample',
    timeit(() => part1(inputSample))
  ); // 21
if (runs[1])
  console.log(
    'part1 real',
    timeit(() => part1(inputReal))
  ); // 7857
if (runs[0])
  console.log(
    'part1 fast sample',
    timeit(() => part1Fast(inputSample))
  ); // 21
if (runs[1])
  console.log(
    'part1 fast real',
    timeit(() => part1Fast(inputReal))
  ); // 7857
if (runs[2])
  console.log(
    'part2 sample',
    timeit(() => part2(inputSample))
  ); // 525152
if (runs[3])
  console.log(
    'part2 real',
    timeit(() => part2(inputReal))
  ); // 28606137449920
