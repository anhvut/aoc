import {consoleTimeit, DOWN, LEFT, pointAdd, RIGHT, serializePoint, UP} from '../util';
import {sum} from 'es-toolkit';
import {fromPairs} from 'es-toolkit/compat';

function findChar(grid: string[][], char = '^') {
  for (let y = 0; y < grid.length; y++) {
    for (let x = 0; x < grid[0].length; x++) {
      if (grid[y][x] === char) {
        return [x, y];
      }
    }
  }
  return null;
}

const nextDir = fromPairs([[UP, RIGHT], [RIGHT, DOWN], [DOWN, LEFT], [LEFT, UP]].map(([prev, next])=> [serializePoint(prev), (next)]));

function walkGrid(grid: string[][], x: number, y: number) {
  let dir = UP;
  grid[y][x] = 'X';
  let done = false;
  do {
    let [nx, ny] = pointAdd([x, y], dir);
    switch (grid[ny]?.[nx]) {
      case '#':
        dir = nextDir[serializePoint(dir)];
        break;
      case undefined:
        done = true;
        break;
      default:
        [x, y] = [nx, ny];
        grid[y][x] = 'X';
    }
  } while (!done);
}

const part1 = (input: string[]) => {
  const grid = input.map(x => Array.from(x));
  let [x, y] = findChar(grid);
  walkGrid(grid, x, y);
  console.log(grid.map((x) => x.join(' ')).join('\n'));
  return sum(grid.map(x => x.filter(x => x === 'X').length));
};


const isStuckInLoop = (grid: string[][], x: number, y: number, dir = UP) => {
  const visited = {[`${serializePoint([x, y])}_${serializePoint(dir)}`]: true};
  while (true) {
    let [nx, ny] = pointAdd([x, y], dir);
    switch (grid[ny]?.[nx]) {
      case '#':
        dir = nextDir[serializePoint(dir)];
        break;
      case undefined:
        return false;
      default:
        [x, y] = [nx, ny];
        const key = `${serializePoint([x, y])}_${serializePoint(dir)}`;
        if (visited[key]) return true;
        visited[key] = true;
    }
  }
}

const part2 = (input: string[]) => {
  const grid = input.map(x => Array.from(x));
  const [sx, sy] = findChar(grid);
  const walkedGrid = input.map(x => Array.from(x));
  walkGrid(walkedGrid, sx, sy);
  walkedGrid[sy][sx] = '^';
  let result = 0;
  for (let y = 0; y < grid.length; y++) {
    for (let x = 0; x < grid[0].length; x++) {
      if (walkedGrid[y][x] === 'X') {
        grid[y][x] = '#';
        result += Number(isStuckInLoop(grid, sx, sy));
        grid[y][x] = '.';
      }
    }
  }
  return result;
};

// noinspection SpellCheckingInspection
const inputSample = `
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
`
  .trim()
  .split('\n');

// noinspection SpellCheckingInspection
const inputReal = `
.................#.#............................................#................#........................................#.......
.....#.............................................................#.......#...#........................#...........#.......##....
..........................................................#..#........#..........#...............#.#..................#...........
..#...#..........#....#.....#......................................#......#..#............................#..#....................
.........................#....#.............#....................................#............................................#...
.....................#.......#.............#...#..........#.................#.......#...............#............#......#.........
........#.........#.....................................#............#.....................##...#..#..........#...................
....#...................#.....##......#............#...#........................#...................................#.............
...............................................................................#.......#.....#...#................#.#......##.....
..........................................#............................#.#.................................#.........#............
........#...............#...............#...................##......#..................#...............#..........................
.........................#....................................#..........#.........................................##.............
.......#.................#..................................#......#....................#...............#..........#......#.......
.............#.#...#.............#.............................................#...............................##.....#...#.......
.....................................................#............................................#.........................#.....
.#...#..........................................................##.................................#............#...............#.
...........#..#........#.....#.............#.......#............................................#..............#.................#
......#.#.##...............#.......#......#......................................................................#...............#
...#........#.#.....................##...#...........................#..............................#...................#.........
..............#..#....................#...................#.................##..............#.#........................#..........
...........................................................#.........#.......................#......................#.........#...
................................................#............................................#....................................
..#.....................................................#..............#...#.........#.....#........................#.............
.#..............................#......#..............#........................................................#..................
#......#.....#..#..#........#....................#...........##..............................#..#.....#.....#.....................
.................#.....#.....................#.........#..............................#..............##......................#....
...........................................................#...##..............#..........................#....#..................
........#..#............................#.#........................#.....#................#...#...................................
..........................#........#.......................................................................##...................#.
............#....#.............................................#.......#....#.....#........................................#......
..........#............#....#.......................#.#............#..............................................................
......#...#......................................................#..#.............................................................
.#...#.....#.....#......................................................................................#..........#.....#........
...#..#.............................................................................#.............................................
............#...................#...........................................#..............#.....#.....................#.##.......
.................................................#................................................................................
.........................#.......................................#..................#..............................#..............
................................................................................................................................#.
...#...........................................#........#.................................................#......#................
..#...........................................#.......#.....#.................................#....#.............#...............#
........#..............#...................................................................................#......................
...........#......#............#............#..................................#.........#..............#.........#..........#....
.........................#.........#.....#.................................#..................#...............##..#...............
.....#........#.........................................................#....................................#......#....#........
...#..#.......#......#.#..................#..........................^#...........................................................
....................#.#..........................................................................#...#............................
...........................#..........................................................#...........................................
................#..............................................................................#..................................
...............................#............................................................#...................................#.
..............#..........................................#..............#..................#..........#...........................
................#...#..........................#.##..........#.......#..............................#........#..............#.....
...................#.............#....................#...........................................................................
....#....................................#....#................................................#..#...........#...................
....#.#..............#..........#...................#...................................#....................#........#......#....
...........................#...........#..#......#.......................................#.......................#......#.........
.....................................................................................................#.................#..........
...................................................#.............#..........#..............................#......................
................................#...........##....................................................................#....#..........
...........#.......#.......................................................................#............#.....................#...
.#........#.......#........................................#.#...............................#...#...........................#....
..#...............#................#....#............#................................................................#...........
........#..........#.........#....................................................................................#...............
............................................................................#.............................#...............#......#
......................#................................#.............#...#............#...........................................
................................#.............#.................................................................#..............#..
.........#.#..#...............................#....................................................#.#.......#..#........#........
.............................#.......#.....#......................................................#..#............................
..................#.............................................................................#..........#......................
.....................................#....##.................#......................................#....#........................
#.......................................................................................................................#.........
......#....#..#...........................#..#.....#........................................#..................................#..
.......#.....#...............#....#......#....#..........#.....................#....#..........#.....#..#......................##.
..................#..........#.....#........................................................#............##...................#...
........................#....#............#..................................#....#..#.......#...................................#
.....#............................#...............................#..#...................#.....#..#........#....#.#...............
......#...#..#......#..........................#........#....................#.......#...........#..........................#..#..
.....#.............................................................................................#......#......................#
...........................................#......................................................................................
.....#...........................#.#.#............................#..................#............................#.......#.......
........#.......................................................#...................#.......#.....................................
...............#..................................................#.................................................#.............
..##............................................................#..............................................................#..
.......#..................................#......................#.................................#...................#..........
......#.........#..............#....##........#....#................................#.....................................#......#
................#.....................................................................................#.............#.............
#..#..#......#.#.....#..#.................................................................................................#..#....
.....................#.....#................................................#.......#........#.................#........#.#...#...
..................................................................#....#..#...................#................................#..
........................#...........#.......................................................#..#..................................
.#.......#...................................................#..............#.......#...#.........................................
.......##...............#.............................#...........................#...............................................
....#............#....#...#........................#...........................#.#.....#..........................................
...........................#............................#..#..................#...........................#...#...................
...........#.#.............#..........#...........................................................................................
.............#..........#...............#...##.........................#..............#...#.............#..#......................
..................#.....#............#..#.........#...............................................................................
...........................................................#.....#..................#.......................#..#..................
....................................#....#.......##............#.............................#...............#...........#........
......#....................#..................#..........................................#...............................#.#......
......................#...........................................#.....#.................................................#....#..
.....................................#...............#....................................#.....#.............#......##...........
......................#...............................................................##.#..........#....#..................#.....
...........#.............#......................#....................#..................................#......#...........##.....
.....#.#...#......................................................................................................................
.........#.....................................#................#.............#....#......................#..........#............
......##.#.................#...............#..##.......................#...............#.......................................#..
....................#.........#.......#....#..................................#..........................#..............#.........
......................#....#..#..#................................#.......#.......................................................
.........................................##............................##..#..................#..................#...........#....
...................#..................................#................................................................#..........
.#.............#....................................................................................#.............................
......................................#.....#.............#..#............................................#...#............#......
.....................................#..................................#...#.......................##...................#........
...........................................................#...................................................#...........#......
.............................#.......#.......................................#.........................#.....................#...#
.....................#............................................................................................................
#....#.......................................#.........#........#...................................#.....#.........#........#....
.......................................................#......#................................##.#........#.........#..........#.
.........#........................##.....#.............................................................#.................#..#.....
....##....................................................................................................#...#...#...............
.......#.....#.......#.............#........#...............##.#......#...............#.................#..#.........#...#....#...
....................#.................................#........................................................................#..
#...............#....................................#.........#...............................#..#..........##...#...#......#....
............#........................#.....#...#.........#.........#..#......................................#....................
..........#.......#.#.....................#...........#...................#.##....................#..#...#........#..............#
.......................................#.......#........#.....#...........................................#.......#......#........
...............................#.........#..............#......................#..........................................#.#.....
............#........#.............................................#.....................................................##......#
......#.#............................................................................#......#.....#......#................#.......
.........#.............#................#.................#..###..........#.........................#.#....#......................
`
  .trim()
  .split('\n');

const runs = [1, 1, 1, 1];
if (runs[0]) consoleTimeit('part1 sample', () => part1(inputSample));
if (runs[1]) consoleTimeit('part1 real', () => part1(inputReal));
if (runs[2]) consoleTimeit('part2 sample', () => part2(inputSample));
if (runs[3]) consoleTimeit('part2 real', () => part2(inputReal));
